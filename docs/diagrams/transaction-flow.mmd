%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#10B981'}}}%%

sequenceDiagram
    autonumber
    participant Client as ðŸ“± App Mobile
    participant Gateway as ðŸ” API Gateway
    participant Txn as Transaction Service
    participant Wallet as Wallet Service
    participant Bank as Bank Integration
    participant MoMo as Mobile Money
    participant Notif as Notification
    participant Queue as RabbitMQ
    participant DB as PostgreSQL
    participant Ecobank as ðŸ¦ Ecobank API

    Note over Client, Ecobank: ðŸŸ¢ TRANSFERT P2P (WALLET â†’ WALLET)

    Client->>Gateway: POST /transactions/transfer<br/>{receiverPhone, amount, pin}
    Gateway->>Gateway: Validate JWT + PIN
    Gateway->>Txn: Process transfer
    Txn->>DB: Create transaction (PENDING)
    Txn->>Wallet: Check sender balance
    Wallet->>DB: Get wallet balance
    Wallet-->>Txn: Balance OK
    
    Txn->>Wallet: Debit sender
    Wallet->>DB: Update sender wallet (lock)
    Txn->>Wallet: Credit receiver
    Wallet->>DB: Update receiver wallet
    
    Txn->>DB: Update transaction (COMPLETED)
    Txn->>Queue: Publish notification event
    Queue->>Notif: Process notification
    Notif->>Client: Push + SMS
    Txn-->>Client: {transaction: COMPLETED}

    Note over Client, Ecobank: ðŸŸ¢ DEPOT (CASH-IN VIA AGENT)

    Client->>Gateway: POST /agents/{id}/cash-in<br/>{amount, customerPhone}
    Gateway->>Txn: Process cash-in
    Txn->>DB: Create transaction (PENDING)
    Txn->>Wallet: Credit customer wallet
    Wallet->>DB: Update wallet
    Txn->>Wallet: Calculate agent commission
    Wallet->>DB: Credit agent commission wallet
    Txn->>DB: Update transaction (COMPLETED)
    Txn->>Queue: Publish events
    Txn-->>Client: {transaction, commission}

    Note over Client, Ecobank: ðŸŸ¢ VIREMENT BANCAIRE (WALLET â†’ BANQUE)

    Client->>Gateway: POST /transactions/bank-transfer<br/>{bankAccount, amount, pin, otp}
    Gateway->>Gateway: Validate JWT + PIN + OTP
    Gateway->>Txn: Process bank transfer
    Txn->>DB: Create transaction (PENDING)
    Txn->>Wallet: Check & debit wallet
    Wallet->>DB: Update wallet (hold funds)
    
    Txn->>Bank: Initiate transfer
    Bank->>Ecobank: POST /transfers/external
    Ecobank-->>Bank: {reference, status: PROCESSING}
    Bank-->>Txn: Transfer initiated
    Txn->>DB: Update transaction (PROCESSING)
    Txn-->>Client: {transaction: PROCESSING}

    Note over Bank, Ecobank: Webhook callback (async)
    Ecobank->>Bank: POST /webhooks/ecobank<br/>{reference, status: SUCCESS}
    Bank->>Txn: Update transaction status
    Txn->>DB: Update transaction (COMPLETED)
    Txn->>Wallet: Confirm debit
    Txn->>Queue: Publish notification
    Queue->>Notif: Send confirmation
    Notif->>Client: Push + SMS

    Note over Client, Ecobank: ðŸŸ¢ DEPOT MOBILE MONEY (ORANGE MONEY â†’ WALLET)

    Client->>Gateway: POST /transactions/momo-deposit<br/>{provider: ORANGE, amount, phone}
    Gateway->>Txn: Process MoMo deposit
    Txn->>DB: Create transaction (PENDING)
    Txn->>MoMo: Initiate collection
    MoMo->>MoMo: Call Orange Money API
    MoMo-->>Txn: {reference, status: PENDING}
    Txn-->>Client: {transaction: PENDING, ussdCode: "*144#"}

    Note over MoMo, Notif: User confirms on phone
    MoMo->>Txn: Webhook: Payment confirmed
    Txn->>Wallet: Credit user wallet
    Wallet->>DB: Update wallet
    Txn->>DB: Update transaction (COMPLETED)
    Txn->>Queue: Publish notification
    Notif->>Client: Push notification
